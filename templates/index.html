<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>RiyalDirect | Business Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%230b1220'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-size='38' font-family='Arial' fill='%230d9488'%3ER%3C/text%3E%3C/svg%3E">
    <!-- Tailwind CSS v3 with Plugins -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Source+Sans+3:wght@400;600;700&display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Manrope"', '"Source Sans 3"', 'sans-serif'],
                        mono: ['"Source Sans 3"', 'sans-serif'],
                    },
                    colors: {
                        'ultra-dark': '#0f172a',
                        'neon-green': '#0f766e',
                        'cyber-blue': '#1d4ed8',
                        'warning-gold': '#b45309',
                    },
                    fontSize: {
                        'xxs': '0.65rem',
                    }
                }
            }
        }
    </script>
    <style data-purpose="custom-layout">
        body {
            background: radial-gradient(1200px 700px at -10% -25%, #1e3a8a33 0%, transparent 55%),
                radial-gradient(900px 500px at 110% -20%, #0f766e2e 0%, transparent 45%),
                #0b1220;
            color: #e2e8f0;
            font-family: 'Manrope', 'Source Sans 3', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .uppercase {
            letter-spacing: 0.02em;
            text-transform: none;
        }

        .zebra-row:nth-child(even) {
            background-color: rgba(148, 163, 184, 0.08);
        }

        header[data-purpose="main-header"] {
            background: rgba(11, 18, 32, 0.88);
            border-bottom: 1px solid #1e293b;
            backdrop-filter: blur(10px);
        }

        main[data-purpose="dashboard-grid"] section > div,
        main[data-purpose="dashboard-grid"] section > section > div {
            background: rgba(15, 23, 42, 0.78) !important;
            border: 1px solid #243041 !important;
            border-radius: 14px;
            box-shadow: 0 14px 34px rgba(2, 6, 23, 0.45);
        }

        [class*="text-white/"] {
            color: #94a3b8 !important;
        }

        .text-white {
            color: #f8fafc !important;
        }

        .text-slate-600 {
            color: #cbd5e1 !important;
        }

        input {
            border-radius: 10px;
            padding: 0.45rem 0.7rem !important;
            border-color: #334155 !important;
            background: #0b1325 !important;
            color: #e2e8f0 !important;
        }

        button[data-purpose="refresh-button"] {
            background: #0d9488 !important;
            color: #ffffff !important;
            border-color: #0d9488 !important;
        }

        #table-profit-sim td:nth-child(2) {
            font-size: 1.05rem;
            font-weight: 800;
            font-variant-numeric: tabular-nums;
        }

        #table-profit-sim td:nth-child(3) {
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        #sim-divider .matrix-row {
            font-variant-numeric: tabular-nums;
        }

        .book-price {
            font-variant-numeric: tabular-nums;
            text-align: right;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 20px;
        }

        #calc-modal-content {
            border-color: #334155 !important;
            background: #0f172a !important;
            box-shadow: 0 18px 42px rgba(2, 6, 23, 0.7) !important;
        }

        #calc-modal-content .bg-slate-50 {
            background: #111b2e !important;
        }

        #calc-modal-content .border-slate-200 {
            border-color: #334155 !important;
        }

        @media (max-width: 768px) {
            main[data-purpose="dashboard-grid"] {
                padding: 0.75rem !important;
                gap: 0.75rem !important;
            }

            header[data-purpose="main-header"] {
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }

            #val-google-sar,
            #val-xe-sar,
            #val-tko-raw,
            #val-p2p-raw {
                font-size: 1.9rem !important;
                line-height: 1.05 !important;
            }

            #calc-sar,
            #calc-rate-jual {
                font-size: 1.25rem !important;
                padding-top: 0.6rem !important;
                padding-bottom: 0.6rem !important;
            }

            #calc-market-hint {
                font-size: 12px !important;
            }

            #table-p2p-indo-buy,
            #table-p2p-indo-sell,
            #table-p2p-saudi-buy,
            #table-p2p-saudi-sell {
                font-size: 15px !important;
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden text-[12px]">

    <!-- BEGIN: TopBar -->
    <header class="h-14 overflow-x-auto no-scrollbar flex items-center justify-between px-4 md:px-8 shrink-0"
        data-purpose="main-header">
        <div class="flex items-center gap-2 md:gap-6">
            <div class="flex items-center gap-2">
                <span class="w-2.5 h-2.5 rounded-full bg-neon-green "></span>
                <span class="font-bold tracking-widest text-cyber-blue text-sm md:text-base">RIYALDIRECT <span class="hidden md:inline text-white/50 text-xs">BUSINESS DESK</span></span>
            </div>
            <div class="hidden md:flex items-center gap-4 text-white/50 border-l border-white/10 pl-4 whitespace-nowrap">
                <span><span class="hidden sm:inline">SYSTEM: </span><span id="system-status" class="text-neon-green">ONLINE</span></span>
                <span><span class="hidden sm:inline">EXCHANGE: </span><span id="binance-status" class="text-neon-green">CONNECTED</span></span>
            </div>
        </div>
        <div class="flex items-center gap-2 md:gap-4 text-slate-600">
            <span class="font-mono text-xs md:text-sm" id="digital-clock">--:--</span>
            <div class="hidden md:flex items-center gap-2 px-2 py-0.5 border border-white/15 text-xs bg-white/5">
                <span class="text-white/50 uppercase tracking-widest">Network</span>
                <span id="latency-mini-val" class="text-neon-green font-bold tabular-nums">--ms</span>
                <div class="flex items-center gap-1 ml-1">
                    <span id="lat-dot-red" class="w-2 h-2 rounded-sm bg-red-500/40"></span>
                    <span id="lat-dot-blue" class="w-2 h-2 rounded-sm bg-blue-500/40"></span>
                    <span id="lat-dot-green" class="w-2 h-2 rounded-sm bg-emerald-400/40"></span>
                </div>
            </div>
            <button onclick="syncData()"
                class="flex items-center gap-1.5 bg-neon-green/10 hover:bg-neon-green/20 text-neon-green px-3 py-1 border border-neon-green/30 text-xs uppercase tracking-widest transition-all active:scale-95"
                data-purpose="refresh-button">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                        stroke-linecap="round" stroke-linejoin="round" stroke-width="2" />
                </svg>
                SYNC
            </button>
        </div>
    </header>
    <!-- END: TopBar -->

    <!-- BEGIN: MainContent -->
    <main class="h-[calc(100vh-56px)] p-4 md:p-5 grid grid-cols-12 gap-3 overflow-y-auto overflow-x-hidden" data-purpose="dashboard-grid">

        <!-- BEGIN: Column 1 - Kurs Displays -->
        <section class="col-span-12 lg:col-span-3 flex flex-col gap-3 items-start h-full lg:overflow-y-auto"
            data-purpose="kurs-metrics">
            <div class="grid grid-cols-2 gap-2 w-full">
                <!-- Google SAR Card -->
                <div class="bg-white/5 border p-3 flex flex-col relative h-fit w-full gap-1.5">
                    <div class="flex items-center justify-between">
                        <h3 class="text-cyber-blue font-bold uppercase tracking-normal leading-tight text-sm">GOOGLE RATE</h3>
                    </div>
                    <p id="val-google-sar" class="text-[2.05rem] sm:text-[2.15rem] font-extrabold text-white tabular-nums leading-none">0.00</p>
                </div>

                <!-- XE.com SAR Card -->
                <div class="bg-white/5 border p-3 flex flex-col relative h-fit w-full gap-1.5">
                    <div class="flex items-center justify-between">
                        <h3 class="text-cyber-blue font-bold uppercase tracking-normal leading-tight text-sm">XE.COM RATE</h3>
                    </div>
                    <p id="val-xe-sar" class="text-[2.05rem] sm:text-[2.15rem] font-extrabold text-white tabular-nums leading-none">0.00</p>
                </div>
            </div>

            <!-- Tokocrypto Card -->
            <div class="bg-white/5 border p-3 flex flex-col relative h-fit w-full gap-1.5">
                <div class="flex items-center justify-between">
                    <h3 class="text-warning-gold font-bold uppercase tracking-normal leading-tight text-sm">TKO NET COST
                    </h3>
                    <span class="bg-warning-gold/20 text-warning-gold text-xs px-1 font-bold">FEE 0.2222%</span>
                </div>
                <div class="flex items-baseline justify-between">
                    <p id="val-tko-raw" class="text-[1.95rem] sm:text-[2.05rem] font-extrabold text-white tabular-nums leading-none">0.00</p>
                </div>
            </div>

            <!-- P2P Net Cost Card -->
            <div class="bg-white/5 border p-3 flex flex-col relative h-fit w-full gap-1.5">
                <div class="flex items-center justify-between">
                    <h3 class="text-cyber-blue font-bold uppercase tracking-normal leading-tight text-sm">P2P NET COST
                    </h3>
                    <span class="bg-cyber-blue/20 text-cyber-blue text-xs px-1 font-bold">TOP #1 SELL</span>
                </div>
                <div class="flex items-baseline justify-between">
                    <p id="val-p2p-raw" class="text-[1.95rem] sm:text-[2.05rem] font-extrabold text-white tabular-nums leading-none">0.00</p>
                </div>
            </div>

            <!-- Kalkulator Arbitrase -->
            <div class="bg-white/5 border p-4 flex flex-col relative w-full flex-1">
                <h3 class="text-warning-gold font-bold uppercase tracking-normal mb-2 text-base">TRADE CALCULATOR</h3>
                <div class="space-y-3 h-full flex flex-col justify-start">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <div class="flex flex-col gap-0.5">
                            <label class="text-base text-white/40 uppercase">Volume SAR</label>
                            <input id="calc-sar"
                                class="bg-black border border-white/10 text-white text-base px-2 py-0.5 focus:border-neon-green outline-none w-full"
                                placeholder="1000" type="text" value="1000" />
                        </div>
                        <div class="flex flex-col gap-0.5">
                            <label class="text-base text-white/40 uppercase">Client Sell Rate</label>
                            <input id="calc-rate-jual"
                                class="bg-black border border-white/10 text-white text-base px-2 py-0.5 focus:border-neon-green outline-none w-full"
                                placeholder="4480" type="text" value="4480" />
                        </div>
                    </div>
                    <button onclick="runCalc()"
                        class="w-full bg-neon-green text-black font-bold text-sm sm:text-base py-2.5 mt-1 hover:bg-neon-green/80 transition-colors uppercase tracking-wide rounded-md">CALCULATE PROFIT</button>
                    <p id="calc-market-hint" class="text-[11px] text-white/45 tracking-wide leading-relaxed border-t border-white/10 pt-2">Live input: waiting market data...</p>
                </div>
            </div>
        </section>
        <!-- END: Column 1 -->

        <!-- BEGIN: Columns 2 & 3 - P2P Tables -->
        <section class="col-span-12 lg:col-span-6 grid grid-cols-1 md:grid-cols-2 gap-3 h-auto lg:h-full lg:overflow-y-auto" data-purpose="p2p-tables">
            <!-- Indonesia Table -->
            <div class="bg-white/5 border border-white/10 flex flex-col min-h-0">
                <div class="p-2 bg-white/5 border-b border-white/10">
                    <h2 class="font-bold text-cyber-blue uppercase tracking-widest text-center">INDONESIA P2P MARKET (IDR)</h2>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-0.5 mt-2 pt-2 border-t border-white/10 text-sm whitespace-nowrap">
                        <div><span class="text-white/40">TKO:</span> <span id="sub-toko"
                                class="text-white">--</span>
                        </div>
                        <div><span class="text-white/40">IDX:</span> <span id="sub-indodax"
                                class="text-white">--</span></div>
                        <div><span class="text-white/40">PTU:</span> <span id="sub-pintu" class="text-white">--</span>
                        </div>
                        <div><span class="text-white/40">OSL:</span> <span id="sub-osl" class="text-white">--</span>
                        </div>
                    </div>
                </div>
                <div class="flex-grow p-1 flex flex-col gap-2 min-h-0">
                    <div class="border border-white/5 flex-1 min-h-0">
                        <div class="bg-white/5 text-base px-2 py-1 font-bold text-neon-green">P2P BUY</div>
                        <div class="overflow-y-auto max-h-[26vh] md:max-h-[34vh]">
                            <table class="w-full text-base">
                                <tbody id="table-p2p-indo-buy" class="text-white/60"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="border border-white/5 flex-1 min-h-0">
                        <div class="bg-white/5 text-base px-2 py-1 font-bold text-cyber-blue">P2P SELL</div>
                        <div class="overflow-y-auto max-h-[26vh] md:max-h-[34vh]">
                            <table class="w-full text-base">
                                <tbody id="table-p2p-indo-sell" class="text-white/60"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saudi Table -->
            <div class="bg-white/5 border border-white/10 flex flex-col min-h-0">
                <div class="p-2 bg-white/5 border-b border-white/10">
                    <h2 class="font-bold text-warning-gold uppercase tracking-widest text-center">SAUDI P2P MARKET (SAR)</h2>
                    <div class="flex justify-center mt-2 pt-2 border-t border-white/10 text-base">
                        <span class="text-white/40">USDT/SAR SPOT:</span> <span id="sub-sar-spot"
                            class="text-white ml-2">--</span>
                    </div>
                </div>
                <div class="flex-grow p-1 flex flex-col gap-2 min-h-0">
                    <div class="border border-white/5 flex-1 min-h-0">
                        <div class="bg-white/5 text-base px-2 py-1 font-bold text-neon-green">P2P BUY</div>
                        <div class="overflow-y-auto max-h-[26vh] md:max-h-[34vh]">
                            <table class="w-full text-base">
                                <tbody id="table-p2p-saudi-buy" class="text-white/60"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="border border-white/5 flex-1 min-h-0">
                        <div class="bg-white/5 text-base px-2 py-1 font-bold text-cyber-blue">P2P SELL</div>
                        <div class="overflow-y-auto max-h-[26vh] md:max-h-[34vh]">
                            <table class="w-full text-base">
                                <tbody id="table-p2p-saudi-sell" class="text-white/60"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </section>
        <!-- END: Columns 2 & 3 -->

        <!-- BEGIN: Column 4 - Simulasi Cuan -->
        <section class="col-span-12 lg:col-span-3 flex flex-col gap-2 lg:overflow-y-auto" data-purpose="profit-simulation">
            <div class="bg-white/5 border border-neon-green/30 flex flex-col min-h-0">
                <div class="p-2 bg-neon-green/10 border-b border-neon-green/20">
                    <h2 class="font-bold text-neon-green uppercase tracking-widest text-center text-base">PRICING MATRIX (NET)</h2>
                </div>
                <div class="grid grid-cols-2 gap-2 px-2 py-1 border-b border-white/10 text-[10px] uppercase text-white/50">
                    <span>Scenario</span>
                    <span class="text-right">Estimated Cost (Rp/SAR)</span>
                </div>
                <div id="sim-divider" class="p-2 space-y-1 overflow-y-auto max-h-[42vh]"></div>
                <div class="p-2 bg-white/5">
                    <p class="text-[10px] text-white/30 leading-tight italic">
                        *Formula: (Google - 5/10/15) / SAR rate (3.78-3.82), then plus TKO fee.
                    </p>
                </div>
            </div>

            <div class="bg-white/5 border border-white/10 flex flex-col shrink-0">
                <div class="p-2 bg-white/5 border-b border-white/10">
                    <h2 class="font-bold text-cyber-blue uppercase tracking-widest text-center text-base">MARKET SNAPSHOT</h2>
                </div>
                <div class="p-3 space-y-2 text-sm">
                    <div class="flex items-center justify-between border-b border-white/10 pb-1">
                        <span class="text-white/50">Google SAR</span>
                        <span id="snap-google" class="text-white font-semibold">--</span>
                    </div>
                    <div class="flex items-center justify-between border-b border-white/10 pb-1">
                        <span class="text-white/50">XE SAR</span>
                        <span id="snap-xe" class="text-white font-semibold">--</span>
                    </div>
                    <div class="flex items-center justify-between border-b border-white/10 pb-1">
                        <span class="text-white/50">TKO Net</span>
                        <span id="snap-tko-net" class="text-white font-semibold">--</span>
                    </div>
                    <div class="flex items-center justify-between border-b border-white/10 pb-1">
                        <span class="text-white/50">IDR Spread</span>
                        <span id="snap-indo-spread" class="text-warning-gold font-semibold">--</span>
                    </div>
                    <div class="flex items-center justify-between border-b border-white/10 pb-1">
                        <span class="text-white/50">SAR Spread</span>
                        <span id="snap-saudi-spread" class="text-warning-gold font-semibold">--</span>
                    </div>
                    <div class="pt-1">
                        <p class="text-[10px] text-white/50 uppercase mb-1">Opportunity Signal</p>
                        <p id="snap-signal" class="text-sm font-bold text-neon-green">Waiting market data...</p>
                    </div>
                </div>
            </div>

        </section>
        <!-- END: Column 4 -->

    </main>
    <!-- END: MainContent -->


    <!-- JavaScript for live clock, data sync, and calculator -->
    <script data-purpose="app-logic">
        const fmt = (v, dec = 2) => v ? Number(v).toLocaleString('id-ID', { minimumFractionDigits: dec, maximumFractionDigits: dec }) : '0';
        let latestMarketData = null;
        const lastSnapshot = { indoSpread: null, saSpread: null };

        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const yyyy = now.getFullYear();
            
            // Mobile: Time only. Desktop: Time + Date
            if (window.innerWidth < 768) {
                document.getElementById('digital-clock').textContent = `${h}:${m}:${s} WIB`; 
            } else {
                            if (window.innerWidth < 768) {
                document.getElementById('digital-clock').textContent = `${h}:${m}:${s} WIB`;
            } else {
                document.getElementById('digital-clock').textContent = `${h}:${m}:${s} WIB | ${dd}/${mm}/${yyyy}`;
            }
            }

        }
        setInterval(updateClock, 1000);
        updateClock();

        function addLog(msg) {
            console.log(msg.replace(/<[^>]*>/g, ''));
        }

        function updateLatencyIndicator(latency) {
            const topVal = document.getElementById('latency-mini-val');
            if (topVal) topVal.textContent = `${latency}ms`;

            const red = document.getElementById('lat-dot-red');
            const blue = document.getElementById('lat-dot-blue');
            const green = document.getElementById('lat-dot-green');
            if (!(red && blue && green)) return;

            red.className = 'w-2 h-2 rounded-sm bg-red-500/40';
            blue.className = 'w-2 h-2 rounded-sm bg-blue-500/40';
            green.className = 'w-2 h-2 rounded-sm bg-emerald-400/40';

            if (latency < 500) {
                green.className = 'w-2 h-2 rounded-sm bg-emerald-400';
            } else if (latency < 2000) {
                blue.className = 'w-2 h-2 rounded-sm bg-blue-500';
            } else {
                red.className = 'w-2 h-2 rounded-sm bg-red-500';
            }
        }

        function renderP2PTable(data, tbodyId, isSAR, highlight) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;
            let html = '';
            data.forEach((x, i) => {
                const colorClass = i === 0 ? highlight : '';
                const priceStr = isSAR
                    ? x.price.toFixed(2)
                    : Number(x.price).toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const seller = x.url
                    ? `<a href="${x.url}" target="_blank" rel="noopener noreferrer" class="text-inherit hover:underline">${x.name}</a>`
                    : `${x.name}`;
                html += `<tr class="zebra-row"><td class="p-1">${seller}</td><td class="p-1 book-price ${colorClass}">${priceStr}</td></tr>`;
            });
            tbody.innerHTML = html;
        }

        async function syncData() {
            const t0 = performance.now();
            try {
                addLog('Data synchronization started...');
                const res = await fetch('/api/data');
                const d = await res.json();
                latestMarketData = d;
                const latency = Math.round(performance.now() - t0);
                const setText = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                    return el;
                };

                // Clock info
                
                if (window.innerWidth < 768) {
                    document.getElementById('digital-clock').textContent = `${d.time} WIB`;
                } else {
                                if (window.innerWidth < 768) {
                // Short time format from sync data usually HH:MM:SS
                // Try to substring if possible, or just use d.time
                document.getElementById('digital-clock').textContent = `${d.time} WIB`;
            } else {
                document.getElementById('digital-clock').textContent = `${d.time} WIB | ${d.date}`;
            }
                }


                // Kurs Cards
                setText('val-google-sar', fmt(d.google_sar));
                setText('val-xe-sar', fmt(d.xe_sar));
                const indoSellTop1 = (Array.isArray(d.p2p_indo_sell) && d.p2p_indo_sell.length > 0)
                    ? Number(d.p2p_indo_sell[0].price || 0)
                    : 0;
                setText('val-tko-raw', fmt(d.tko_raw));
                const p2pBase = indoSellTop1;
                setText('val-p2p-raw', fmt(p2pBase));

                // Margin indicator
                if (d.google_sar && d.tko_net) {
                    const base = d.tko_net / 3.79;
                    const margin = ((d.google_sar - base) / base * 100);
                    const marginEl = setText('margin-indicator', `${margin >= 0 ? '+' : ''}${margin.toFixed(2)}%`);
                    if (marginEl) marginEl.className = margin >= 0 ? 'text-neon-green' : 'text-red-500';
                }

                // Sub-header exchange values
                setText('sub-toko', d.tko_raw ? fmt(d.tko_raw, 0) : '--');
                setText('sub-indodax', d.indodax_raw ? fmt(d.indodax_raw, 0) : '--');
                setText('sub-pintu', d.pintu_raw ? fmt(d.pintu_raw, 0) : '--');
                setText('sub-osl', d.osl_raw ? fmt(d.osl_raw, 0) : '--');

                // SAR spot (use first Saudi buy price if available)
                if (d.p2p_saudi_buy && d.p2p_saudi_buy.length > 0) {
                    setText('sub-sar-spot', d.p2p_saudi_buy[0].price.toFixed(2));
                }

                // P2P Tables — BUY and SELL
                renderP2PTable(d.p2p_indo_buy, 'table-p2p-indo-buy', false, 'text-warning-gold');
                renderP2PTable(d.p2p_indo_sell, 'table-p2p-indo-sell', false, 'text-neon-green');
                renderP2PTable(d.p2p_saudi_buy, 'table-p2p-saudi-buy', true, 'text-neon-green');
                renderP2PTable(d.p2p_saudi_sell, 'table-p2p-saudi-sell', true, 'text-warning-gold');

                // Divider Simulation
                const matrixRows = (d.sim_div || []);
                let hD = '';
                matrixRows.forEach(item => {
                    hD += `<div class="matrix-row flex justify-between items-center border-b border-white/5 py-1 px-1">
            <span class="text-white/40 text-base uppercase">${item.label}</span>
            <span class="text-base font-bold text-white">Rp ${fmt(item.val, 4)}</span>
          </div>`;
                });
                const simDiv = document.getElementById('sim-divider');
                if (simDiv) simDiv.innerHTML = hD;

                // Market Snapshot (fills empty right-column space with actionable context)
                const indoBuy = d.p2p_indo_buy && d.p2p_indo_buy.length ? d.p2p_indo_buy[0].price : 0;
                const indoSell = d.p2p_indo_sell && d.p2p_indo_sell.length ? d.p2p_indo_sell[0].price : 0;
                const saBuy = d.p2p_saudi_buy && d.p2p_saudi_buy.length ? d.p2p_saudi_buy[0].price : 0;
                const saSell = d.p2p_saudi_sell && d.p2p_saudi_sell.length ? d.p2p_saudi_sell[0].price : 0;
                const indoSpread = (indoSell && indoBuy) ? (indoSell - indoBuy) : null;
                const saSpread = (saSell && saBuy) ? (saSell - saBuy) : null;
                if (indoSpread !== null) lastSnapshot.indoSpread = indoSpread;
                if (saSpread !== null) lastSnapshot.saSpread = saSpread;

                document.getElementById('snap-google').textContent = d.google_sar ? `Rp ${fmt(d.google_sar, 2)}` : '--';
                document.getElementById('snap-xe').textContent = d.xe_sar ? `Rp ${fmt(d.xe_sar, 2)}` : '--';
                document.getElementById('snap-tko-net').textContent = d.tko_net ? `Rp ${fmt(d.tko_net, 0)}` : '--';
                const indoSpreadShown = indoSpread !== null ? indoSpread : lastSnapshot.indoSpread;
                const saSpreadShown = saSpread !== null ? saSpread : lastSnapshot.saSpread;
                document.getElementById('snap-indo-spread').textContent = indoSpreadShown !== null ? `Rp ${fmt(indoSpreadShown, 2)}` : '--';
                document.getElementById('snap-saudi-spread').textContent = saSpreadShown !== null ? `Rp ${fmt(saSpreadShown, 2)}` : '--';

                const signalEl = document.getElementById('snap-signal');
                if (signalEl) {
                    if (indoSpread !== null && saSpread !== null && indoSpread > 0 && saSpread > 0) {
                        signalEl.textContent = 'Healthy spread across both markets.';
                        signalEl.className = 'text-sm font-bold text-neon-green';
                    } else if (indoSpread !== null && saSpread !== null && indoSpread === 0 && saSpread === 0) {
                        signalEl.textContent = 'Seller-only mode: spread fixed at Rp 0.00.';
                        signalEl.className = 'text-sm font-bold text-cyber-blue';
                    } else if ((indoSpread === null || saSpread === null) && (lastSnapshot.indoSpread !== null || lastSnapshot.saSpread !== null)) {
                        signalEl.textContent = 'P2P feed delayed. Using last valid snapshot.';
                        signalEl.className = 'text-sm font-bold text-warning-gold';
                    } else if (indoSpread === null || saSpread === null) {
                        signalEl.textContent = 'Waiting for complete order book data.';
                        signalEl.className = 'text-sm font-bold text-warning-gold';
                    } else {
                        signalEl.textContent = 'Thin spread. Review entry timing.';
                        signalEl.className = 'text-sm font-bold text-warning-gold';
                    }
                }

                // Latency
                updateLatencyIndicator(latency);

                // XE Update
                setText('xe-update-time', 'JUST NOW');

                // Auto-fill calculator with live rates
                if (d.google_sar) {
                    const calcRate = document.getElementById('calc-rate-jual');
                    if (calcRate) calcRate.value = Math.round(d.google_sar);
                }
                const p2pTop = d.p2p_saudi_buy && d.p2p_saudi_buy.length ? d.p2p_saudi_buy[0].price.toFixed(2) : '--';
                const tkoTop = d.tko_net ? Math.round(d.tko_net).toLocaleString('id-ID') : (d.tko_raw ? Math.round(d.tko_raw).toLocaleString('id-ID') : '--');
                const hintEl = document.getElementById('calc-market-hint');
                if (hintEl) hintEl.textContent = `Live input: SAR P2P ${p2pTop} | TKO NET ${tkoTop}`;

                addLog(`Google benchmark synced... <span class="text-neon-green">OK (SAR/IDR: ${fmt(d.google_sar)})</span>`);
                addLog(`Tokocrypto spot synced... <span class="text-neon-green">${fmt(d.tko_raw)} IDR</span>`);
                addLog(`Pricing matrix recalculated (Google-5..15 / 3.78..3.82 + fee)...`);
                addLog(`P2P market scan active (IDR &amp; SAR)...`);
                addLog(`<span class="text-neon-green">SYNC COMPLETE</span> — Latency: ${latency}ms`);

                const systemEl = setText('system-status', 'ONLINE');
                if (systemEl) systemEl.className = 'text-neon-green';
                const exchangeEl = setText('binance-status', 'CONNECTED');
                if (exchangeEl) exchangeEl.className = 'text-neon-green';



            } catch (e) {
                console.error(e);
                addLog(`<span class="text-red-500">ERROR: Synchronization failed — ${e.message}</span>`);
                const systemEl = document.getElementById('system-status');
                if (systemEl) {
                    systemEl.textContent = 'ERROR';
                    systemEl.className = 'text-red-500';
                }
                const exchangeEl = document.getElementById('binance-status');
                if (exchangeEl) {
                    exchangeEl.textContent = 'DISCONNECTED';
                    exchangeEl.className = 'text-red-500';
                }
            }
        }

        function runCalc() {
            const sarAmount = parseFloat(document.getElementById('calc-sar').value) || 0;
            const rateJual = parseFloat(document.getElementById('calc-rate-jual').value) || 0;
            const rateP2P = latestMarketData?.p2p_saudi_buy?.[0]?.price || 0;
            const rateTokoNet = latestMarketData?.tko_net || latestMarketData?.tko_raw || 0;

            if (!(sarAmount && rateJual && rateP2P && rateTokoNet)) {
                alert('Market data is not ready. Click SYNC and try again.');
                return;
            }

            // 1. Buyer bayar IDR
            const buyerBayar = sarAmount * rateJual;

            // 2. USDT yang dibutuhkan (SAR / rate P2P Saudi)
            const usdtNeeded = sarAmount / rateP2P;

            // 3. Modal beli USDT di OSL (pakai harga NET, fee sudah masuk)
            const modalIdr = usdtNeeded * rateTokoNet;

            // 4. Profit & ROI
            const profit = buyerBayar - modalIdr;
            const roi = modalIdr > 0 ? (profit / modalIdr * 100) : 0;
            const kursEfektif = modalIdr / sarAmount;

            // Populate modal
            document.getElementById('m-sar-amount').textContent = `${sarAmount.toLocaleString('id-ID')} SAR`;
            document.getElementById('m-buyer-bayar').textContent = `Rp ${Math.round(buyerBayar).toLocaleString('id-ID')}`;
            document.getElementById('m-usdt-needed').textContent = `${usdtNeeded.toLocaleString('id-ID', { maximumFractionDigits: 2 })} USDT`;
            document.getElementById('m-modal-idr').textContent = `Rp ${Math.round(modalIdr).toLocaleString('id-ID')}`;
            document.getElementById('m-kurs-efektif').textContent = `Rp ${Math.round(kursEfektif).toLocaleString('id-ID')}/SAR`;

            const profitEl = document.getElementById('m-profit');
            profitEl.textContent = `${profit >= 0 ? '+' : ''}Rp ${Math.round(Math.abs(profit)).toLocaleString('id-ID')}`;
            profitEl.className = `text-4xl font-extrabold ${profit >= 0 ? 'text-neon-green' : 'text-red-500'}`;

            const roiEl = document.getElementById('m-roi');
            roiEl.textContent = `${roi >= 0 ? '+' : ''}${roi.toFixed(2)}%`;
            roiEl.className = `text-sm font-bold ${roi >= 0 ? 'text-warning-gold' : 'text-red-500'}`;

            // Show modal
            const m = document.getElementById('calc-modal');
            m.classList.remove('hidden');
            m.classList.add('flex');
        }

        function closeCalcModal() {
            const m = document.getElementById('calc-modal');
            m.classList.add('hidden');
            m.classList.remove('flex');
        }

        // Close modal on backdrop click
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('calc-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('calc-modal')) closeCalcModal();
            });
        });

        // Auto-refresh every 60 seconds
        setInterval(syncData, 60000);
        // Initial load
        syncData();
    </script>

    <!-- Calculator Result Modal -->
    <div id="calc-modal" class="fixed inset-0 z-[100] hidden items-center justify-center"
        style="background:rgba(0,0,0,0.7);backdrop-filter:blur(6px)">
        <div id="calc-modal-content"
            class="relative w-[92%] max-w-lg border border-slate-200 bg-white shadow-2xl shadow-slate-300/30 rounded-2xl"
            style="animation:modalIn 0.25s ease-out">
            <!-- Header -->
            <div class="flex items-center justify-between p-5 bg-slate-50 border-b border-slate-200">
                <div class="flex items-center gap-2">
                    <span class="w-2.5 h-2.5 rounded-full bg-neon-green "></span>
                    <h3 class="text-neon-green font-bold uppercase tracking-widest text-xs">TRADE RESULT SUMMARY
                    </h3>
                </div>
                <button onclick="closeCalcModal()"
                    class="text-white/40 hover:text-white transition-colors text-lg leading-none">&times;</button>
            </div>
            <!-- Body -->
            <div class="p-6 space-y-4">
                <!-- Step 1: Client -->
                <div class="bg-cyber-blue/5 border border-cyber-blue/20 p-3">
                    <p class="text-base text-cyber-blue uppercase mb-1 font-bold">Step 1 - Client Payment</p>
                    <div class="flex justify-between items-center">
                        <span id="m-sar-amount" class="text-sm font-bold text-white">0 SAR</span>
                        <span class="text-white/30">&rarr;</span>
                        <span id="m-buyer-bayar" class="text-sm font-bold text-cyber-blue">Rp 0</span>
                    </div>
                </div>
                <!-- Step 2: USDT -->
                <div class="bg-warning-gold/5 border border-warning-gold/20 p-3">
                    <p class="text-base text-warning-gold uppercase mb-1 font-bold">Step 2 - USDT Purchase</p>
                    <div class="flex justify-between items-center">
                        <span id="m-usdt-needed" class="text-sm font-bold text-white">0 USDT</span>
                        <span class="text-white/30">&rarr;</span>
                        <span id="m-modal-idr" class="text-sm font-bold text-warning-gold">Rp 0</span>
                    </div>
                    <p class="text-base text-white/30 mt-1">Effective Rate: <span id="m-kurs-efektif"
                            class="text-white/60">Rp 0/SAR</span></p>
                </div>
                <!-- Step 3: Profit -->
                <div class="bg-neon-green/5 border border-neon-green/20 p-4 text-center">
                    <p class="text-base text-white/40 uppercase mb-1">Estimated Net Profit</p>
                    <p id="m-profit" class="text-4xl font-extrabold text-neon-green">Rp 0</p>
                    <p id="m-roi" class="text-sm font-bold text-warning-gold mt-1">0.00%</p>
                </div>
                <div class="flex items-center gap-2 pt-2 border-t border-white/10">
                    <svg class="w-3 h-3 text-white/30" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                            clip-rule="evenodd" />
                    </svg>
                    <p class="text-base text-white/30 italic">Estimation only. Execution price can differ at runtime.</p>
                </div>
            </div>
            <!-- Footer -->
            <div class="p-4 bg-slate-50 border-t border-slate-200">
                <button onclick="closeCalcModal()"
                    class="w-full bg-neon-green text-black font-bold text-base py-2 hover:bg-neon-green/80 transition-colors uppercase tracking-widest">CLOSE</button>
            </div>
        </div>
    </div>
    <style>
        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
    </style>


</body>

</html>
